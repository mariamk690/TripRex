@model CoreTripRex.Models.Dashboard.DashboardViewModel
@{
	ViewData["Title"] = "Plan Your Vacation";
}

<section class="py-5">
	<div class="container">
		<div class="row">

			<!-- LEFT COLUMN -->
			<div class="col-lg-9">

				<!-- Header -->
				<div class="d-flex justify-content-between align-items-center mb-3">
					<h1 class="h3 mb-0">Plan your vacation</h1>

					@if (Model.ShowResumeButton)
					{
						<a href="~/CurrentPackage" class="btn btn-outline-primary d-none d-md-inline">
							Resume saved package
						</a>
					}
				</div>

				<!-- Messages -->
				@if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
				{
					<div class="text-muted small mb-3">@Html.Raw(Model.StatusMessage)</div>
				}

				@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
				{
					<div class="text-danger small mb-3">@Model.ErrorMessage</div>
				}

				<!-- ===========================
					 SEARCH FORM
				============================ -->
				<form method="post" asp-action="Search">
					<div class="card p-4 mb-4 shadow-sm">

						<div class="row g-3">
							<div class="col-md-3">
								<label class="form-label">Current Location</label>
								<input asp-for="Origin" class="form-control" placeholder="Philadelphia" />
							</div>

							<div class="col-md-3">
								<label class="form-label">Destination</label>
								<input asp-for="Destination" class="form-control" placeholder="Las Vegas" />
							</div>

							<div class="col-md-3">
								<label class="form-label">Start Date</label>
								<input asp-for="StartDate" type="date" class="form-control" />
							</div>

							<div class="col-md-3">
								<label class="form-label">End Date</label>
								<input asp-for="EndDate" type="date" class="form-control" />
							</div>
						</div>

						<hr class="my-4" />

						<!-- Include Section -->
						<div class="row align-items-center">
							<div class="col-md-8">
								<label class="form-label d-block mb-2">Include in Package</label>

								<div class="d-flex flex-wrap gap-4">

									<div class="form-check">
										<input asp-for="IncludeFlights" class="form-check-input" />
										<label class="form-check-label" asp-for="IncludeFlights">Flights</label>
									</div>

									<div class="form-check">
										<input asp-for="IncludeHotels" class="form-check-input" />
										<label class="form-check-label" asp-for="IncludeHotels">Hotels</label>
									</div>

									<div class="form-check">
										<input asp-for="IncludeCars" class="form-check-input" />
										<label class="form-check-label" asp-for="IncludeCars">Cars</label>
									</div>

									<div class="form-check">
										<input asp-for="IncludeEvents" class="form-check-input" />
										<label class="form-check-label" asp-for="IncludeEvents">Events</label>
									</div>

								</div>
							</div>

							<div class="col-md-4 text-md-end mt-3 mt-md-0">
								<button type="submit" class="btn btn-primary px-4">Find Options</button>
							</div>
						</div>

					</div>
				</form>

				<!-- ===========================
					 FLIGHTS
				============================ -->
				@if (Model.ShowFlights && Model.FlightVendors.Any())
				{
					<div class="mb-5">
						<h2 class="h5 mb-3">Roundtrip Flights</h2>

						<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">

							@foreach (var vendor in Model.FlightVendors)
							{
								<div class="col">
									<div class="card shadow-sm h-100">

										<img src="@vendor.ImageUrl"
											 class="card-img-top"
											 style="height:140px; object-fit:contain; background-color:#f8f9fa;" />

										<div class="card-body d-flex flex-column justify-content-between">
											<div>
												<h5 class="card-title mb-1">@vendor.Vendor</h5>
												<p class="text-muted small mb-0">@vendor.Caption</p>
											</div>

											<div class="mt-auto d-flex justify-content-between align-items-center">
												<button class="btn btn-outline-primary btn-sm"
														type="button"
														data-bs-toggle="collapse"
														data-bs-target="#flight_@vendor.Vendor.GetHashCode()">
													View Flights
												</button>
												<span class="fw-semibold text-primary small">Economy & Business</span>
											</div>
										</div>
										<div id="flight_@vendor.Vendor.GetHashCode()" class="collapse border-top">
											<ul class="list-group list-group-flush">
												@foreach (var f in vendor.Options)
												{
													<li class="list-group-item d-flex justify-content-between align-items-center">
														<div>
															<div class="fw-medium">Flight @f.FlightNumber</div>
															<div class="text-muted small">@f.DepartCode → @f.ArriveCode</div>
															<div class="text-muted small">@f.DepartTime → @f.ArriveTime</div>
															<div class="text-muted small">Class: @f.ClassCode</div>
														</div>

														<div class="text-end">
															<div class="fw-semibold text-primary mb-1">$@f.Price</div>

															<div class="d-flex flex-column gap-1">
																<button type="button"
																		class="btn btn-outline-primary btn-sm"
																		onclick="openSeatChart(@f.FlightID)">
																	Choose Seat
																</button>

																<form method="post" asp-action="AddFlight">
																	<input type="hidden" name="flightId" value="@f.FlightID" />
																	<button type="submit" class="btn btn-success btn-sm w-100">Add</button>
																</form>
															</div>
														</div>
													</li>
												}
											</ul>
										</div>


									</div>
								</div>
							}
						</div>
					</div>
				}

				<!-- ===========================
					 HOTELS
				============================ -->
				@if (Model.ShowHotels && Model.HotelVendors.Any())
				{
					<div class="mb-5">
						<h2 class="h5 mb-3">Hotels</h2>

						<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
							@foreach (var h in Model.HotelVendors)
							{
								<div class="col">
									<div class="card shadow-sm h-100">

										<img src="@h.ImageUrl" class="card-img-top" style="height:160px; object-fit:cover;" />

										<div class="card-body d-flex flex-column">
											<div>
												<h5 class="card-title mb-1">@h.HotelName</h5>
												<p class="text-muted small mb-1">@h.Phone<br />@h.Email</p>
												<p class="text-muted small mb-0">@h.Caption</p>
											</div>

											<div class="mt-auto d-flex justify-content-between align-items-center">
												<button class="btn btn-outline-primary btn-sm"
														type="button"
														data-bs-toggle="collapse"
														data-bs-target="#rooms_@h.VendorID">
													View Rooms
												</button>

												<span class="fw-semibold text-primary">$@h.StartingPrice/night</span>
											</div>
										</div>

										<div id="rooms_@h.VendorID" class="collapse border-top">
											<div class="card-body p-0">

												<div id="carousel_hotel_@h.VendorID" class="carousel slide" data-bs-ride="false">
													<div class="carousel-inner">

														@for (int i = 0; i < h.Rooms.Count; i++)
														{
															var r = h.Rooms[i];

															<div class="carousel-item @(i == 0 ? "active" : "")">
																<img src="@r.ImageUrl" class="card-img-top" style="height:160px; object-fit:cover;" />

																<div class="card-body text-center">
																	<p class="text-muted small mb-1">Max Guests: @r.MaxOccupancy</p>
																	<p class="fw-semibold text-primary mb-2">$@r.PricePerNight/night</p>

																	<form method="post" asp-action="AddRoom">
																		<input type="hidden" name="roomId" value="@r.ID" />
																		<button type="submit" class="btn btn-success btn-sm w-100">Add</button>
																	</form>
																</div>
															</div>
														}

													</div>

													<button class="carousel-control-prev" type="button"
															data-bs-target="#carousel_hotel_@h.VendorID" data-bs-slide="prev">
														<span class="carousel-control-prev-icon"></span>
													</button>
													<button class="carousel-control-next" type="button"
															data-bs-target="#carousel_hotel_@h.VendorID" data-bs-slide="next">
														<span class="carousel-control-next-icon"></span>
													</button>

												</div>

											</div>
										</div>

									</div>
								</div>
							}
						</div>
					</div>
				}

				<!-- ===========================
					 CARS
				============================ -->
				@if (Model.ShowCars && Model.CarVendors.Any())
				{
					<div class="mb-5">
						<h2 class="h5 mb-3">Car Rentals</h2>

						<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
							@foreach (var c in Model.CarVendors)
							{
								<div class="col">
									<div class="card shadow-sm h-100">

										<img src="@c.ImageUrl" class="card-img-top" style="height:160px; object-fit:cover;" />

										<div class="card-body d-flex flex-column">
											<div>
												<h5 class="card-title mb-1">@c.Agency</h5>
												<p class="text-muted small mb-0">@c.Caption</p>
											</div>

											<div class="mt-auto d-flex justify-content-between align-items-center">
												<button class="btn btn-outline-primary btn-sm"
														type="button"
														data-bs-toggle="collapse"
														data-bs-target="#cars_@c.VendorID">
													View Cars
												</button>
												<span class="fw-semibold text-primary">from $@c.StartingPrice/day</span>
											</div>
										</div>

										<div id="cars_@c.VendorID" class="collapse border-top">
											<div class="card-body p-0">

												<div id="carousel_car_@c.VendorID" class="carousel slide" data-bs-ride="false">

													<div class="carousel-inner">
														@for (int i = 0; i < c.Cars.Count; i++)
														{
															var car = c.Cars[i];

															<div class="carousel-item @(i == 0 ? "active" : "")">
																<img src="@car.ImageUrl" class="card-img-top" style="height:160px; object-fit:cover;" />

																<div class="card-body text-center">
																	<p class="text-muted small mb-1">
																		@car.CarClass • Seats: @car.Seats
																	</p>
																	<p class="fw-semibold text-primary mb-2">$@car.DailyRate/day</p>

																	<form method="post" asp-action="AddCar">
																		<input type="hidden" name="carId" value="@car.ID" />
																		<input type="hidden" name="agency" value="@c.Agency" />
																		<input type="hidden" name="model" value="@car.Model" />
																		<input type="hidden" name="carClass" value="@car.CarClass" />
																		<input type="hidden" name="seats" value="@car.Seats" />
																		<input type="hidden" name="dailyRate" value="@car.DailyRate" />
																		<input type="hidden" name="imageUrl" value="@car.ImageUrl" />
																		<button type="submit" class="btn btn-success btn-sm w-100">Add</button>
																	</form>


																</div>
															</div>
														}
													</div>

													<button class="carousel-control-prev" type="button"
															data-bs-target="#carousel_car_@c.VendorID" data-bs-slide="prev">
														<span class="carousel-control-prev-icon"></span>
													</button>

													<button class="carousel-control-next" type="button"
															data-bs-target="#carousel_car_@c.VendorID" data-bs-slide="next">
														<span class="carousel-control-next-icon"></span>
													</button>

												</div>

											</div>
										</div>

									</div>
								</div>
							}
						</div>
					</div>
				}

				<!-- ===========================
					 EVENTS
				============================ -->
				@if (Model.ShowEvents && Model.EventVendors.Any())
				{
					<div class="mb-5">
						<h2 class="h5 mb-3">Events</h2>

						<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
							@foreach (var e in Model.EventVendors)
							{
								<div class="col">
									<div class="card shadow-sm h-100">

										<img src="@e.ImageUrl" class="card-img-top" style="height:160px; object-fit:cover;" />

										<div class="card-body d-flex flex-column">
											<div>
												<h5 class="card-title mb-1">@e.Organizer</h5>
												<p class="text-muted small mb-1">Venue: @e.Venue</p>
												<p class="text-muted small mb-0">@e.Caption</p>
											</div>

											<div class="mt-auto">
												<button class="btn btn-outline-primary btn-sm"
														type="button"
														data-bs-toggle="collapse"
														data-bs-target="#ev_@e.Organizer.GetHashCode()">
													View Events
												</button>
											</div>
										</div>

										<div id="ev_@e.Organizer.GetHashCode()" class="collapse border-top">
											<ul class="list-group list-group-flush">
												@foreach (var ev in e.Events)
												{
													<li class="list-group-item d-flex justify-content-between align-items-center">
														<div>
															<div class="fw-medium">@ev.Name</div>
															<div class="text-muted small"> @ev.StartTime.ToString("ddd, MMM d • h:mm tt")</div>
														</div>
														<div class="text-end">
															<div class="fw-semibold mb-2">
																@(ev.Price == 0 ? "Free" : $"${ev.Price:F2}")
															</div>

															<button type="button"
																	class="btn btn-outline-primary btn-sm mb-2"
																	onclick="openEventSeatChart(@ev.ID)">
																Choose Seat
															</button>

															<form id="eventForm_@ev.ID" method="post" asp-action="AddEvent">
																<input type="hidden" name="apiEventId" value="@ev.ID" />
																<input type="hidden" name="name" value="@ev.Name" />
																<input type="hidden" name="venue" value="@e.Venue" />
																<input type="hidden" name="price" value="@ev.Price" />
																<input type="hidden" name="start" value="@ev.StartTime.ToString("o")" />
																<input type="hidden" name="end" value="@ev.StartTime.AddHours(2).ToString("o")" />
																<button type="submit" class="btn btn-success btn-sm w-100">Add</button>
															</form>
														</div>


													</li>
												}
											</ul>
										</div>

									</div>
								</div>
							}
						</div>
					</div>
				}

			</div> <!-- END LEFT COL -->
			<!-- ===========================
				 RIGHT SIDEBAR — CART
			============================ -->

			<div class="col-lg-3">
				@if (Model.ShowCart && Model.Cart != null && Model.Cart.Items.Any())
				{
					<div class="card p-3 shadow-sm sticky-top" style="top: 90px;">

						<h5 class="mb-3">Your Package</h5>

						@foreach (var item in Model.Cart.Items)
						{
							<div class="border-bottom py-2">
								<div class="d-flex justify-content-between">

									<div>
										<strong>@item.ServiceType</strong><br />
										<span class="fw-semibold">@item.DisplayName</span><br />
										<span class="text-muted small">@item.Details</span><br />
										<span class="text-muted small">Ref ID: @item.RefId</span>
									</div>

									<div class="text-end">
										<div class="fw-semibold text-primary">$@item.ItemPrice</div>
										<div class="text-muted small">
											x @item.Quantity = $@item.ComputedPrice
										</div>
									</div>

								</div>
							</div>
						}

						<div class="d-flex justify-content-between align-items-center mt-3">
							<div class="fw-bold">Total: $@Model.Cart.Total</div>

							<div class="d-flex gap-2">
								<a href="~/CurrentPackage" class="btn btn-primary btn-sm">View all</a>
								<a href="~/Checkout" class="btn btn-primary btn-sm">Checkout</a>
							</div>
						</div>

					</div>
				}
			</div>

		</div>
	</div>
	<!-- ================================
		 SEATING CHART MODAL
	================================ -->
	<div class="modal fade" id="seatModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title">Choose Your Seat</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body">

					<div id="seat-loading" class="text-center my-4">
						<div class="spinner-border"></div>
						<p class="mt-2">Loading seat map...</p>
					</div>

					<div id="seat-grid" class="d-none">
						<!-- seats dynamically injected -->
					</div>

					<div id="seat-selected" class="mt-3 text-center fw-bold text-primary d-none">
					</div>

				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button id="confirmSeatBtn"
							class="btn btn-primary d-none"
							onclick="confirmSeatSelection()">
						Confirm Seat
					</button>
				</div>

			</div>
		</div>
	</div>
	<script>
		let selectedSeats = [];
		let selectedFlightId = null;
		let currentSeatMode = null;
		let selectedEventData = null;

		function openSeatChart(flightId) {
			currentSeatMode = "flight";
			selectedFlightId = flightId;
			selectedEventData = null;
			selectedSeats = [];

			var loading = document.getElementById("seat-loading");
			var grid = document.getElementById("seat-grid");
			var confirmBtn = document.getElementById("confirmSeatBtn");
			var selected = document.getElementById("seat-selected");

			loading.classList.remove("d-none");
			grid.classList.add("d-none");
			confirmBtn.classList.add("d-none");
			selected.classList.add("d-none");

			var modal = new bootstrap.Modal(document.getElementById("seatModal"));
			modal.show();

			fetch("/api/Flights/GetSeats?flightId=" + flightId)
				.then(function (res) { return res.json(); })
				.then(function (seats) { renderSeatGrid(seats); })
				.catch(function () { alert("Error loading seat chart"); });
		}

		function openEventSeatChart(apiEventId, name, venue, price, startIso, endIso) {
			currentSeatMode = "event";
			selectedFlightId = null;
			selectedEventData = {
				apiEventId: apiEventId,
				name: name,
				venue: venue,
				price: price,
				start: startIso,
				end: endIso
			};
			selectedSeats = [];

			var loading = document.getElementById("seat-loading");
			var grid = document.getElementById("seat-grid");
			var confirmBtn = document.getElementById("confirmSeatBtn");
			var selected = document.getElementById("seat-selected");

			loading.classList.remove("d-none");
			grid.classList.add("d-none");
			confirmBtn.classList.add("d-none");
			selected.classList.add("d-none");

			var modal = new bootstrap.Modal(document.getElementById("seatModal"));
			modal.show();

			var seats = [];
			var cols = ["A", "B", "C", "D", "E", "F"];
			for (var row = 1; row <= 10; row++) {
				for (var i = 0; i < cols.length; i++) {
					seats.push({ seatNumber: row.toString() + cols[i], isAvailable: true });
				}
			}

			renderSeatGrid(seats);
		}

		function renderSeatGrid(seats) {
			var grid = document.getElementById("seat-grid");
			grid.innerHTML = "";

			var html = '<div class="d-flex flex-wrap gap-2 justify-content-center">';

			seats.forEach(function (seat) {
				var cls = seat.isAvailable ? "btn-outline-success" : "btn-outline-secondary disabled";

				html +=
					'<button class="btn ' + cls + ' seat-btn" ' +
					'style="width:55px" ' +
					'onclick="selectSeat(\'' + seat.seatNumber + '\',' + seat.isAvailable + ', this)">' +
					seat.seatNumber +
					'</button>';
			});

			html += "</div>";
			grid.innerHTML = html;

			document.getElementById("seat-loading").classList.add("d-none");
			grid.classList.remove("d-none");
		}

		function selectSeat(seatNumber, available, el) {
			if (!available) return;

			if (selectedSeats.indexOf(seatNumber) !== -1) {
				selectedSeats = selectedSeats.filter(function (s) { return s !== seatNumber; });
				el.classList.remove("btn-primary");
			} else {
				selectedSeats.push(seatNumber);
				el.classList.add("btn-primary");
			}

			updateSeatDisplay();
		}

		function updateSeatDisplay() {
			var msg = document.getElementById("seat-selected");

			if (selectedSeats.length === 0) {
				msg.classList.add("d-none");
				document.getElementById("confirmSeatBtn").classList.add("d-none");
				return;
			}

			msg.innerHTML = "Selected Seats: <strong>" + selectedSeats.join(", ") + "</strong>";

			msg.classList.remove("d-none");
			document.getElementById("confirmSeatBtn").classList.remove("d-none");
		}

		function confirmSeatSelection() {
			if (selectedSeats.length === 0) return;

			var form = document.createElement("form");
			form.method = "POST";

			if (currentSeatMode === "flight") {
				form.action = "/Dashboard/AddFlightWithSeats";

				var flightInput = document.createElement("input");
				flightInput.type = "hidden";
				flightInput.name = "flightId";
				flightInput.value = selectedFlightId;
				form.appendChild(flightInput);

				var qtyInput = document.createElement("input");
				qtyInput.type = "hidden";
				qtyInput.name = "quantity";
				qtyInput.value = selectedSeats.length;
				form.appendChild(qtyInput);
			} else if (currentSeatMode === "event" && selectedEventData) {
				form.action = "/Dashboard/AddEventWithSeats";

				var idInput = document.createElement("input");
				idInput.type = "hidden";
				idInput.name = "apiEventId";
				idInput.value = selectedEventData.apiEventId;
				form.appendChild(idInput);

				var nameInput = document.createElement("input");
				nameInput.type = "hidden";
				nameInput.name = "name";
				nameInput.value = selectedEventData.name;
				form.appendChild(nameInput);

				var venueInput = document.createElement("input");
				venueInput.type = "hidden";
				venueInput.name = "venue";
				venueInput.value = selectedEventData.venue;
				form.appendChild(venueInput);

				var priceInput = document.createElement("input");
				priceInput.type = "hidden";
				priceInput.name = "price";
				priceInput.value = selectedEventData.price;
				form.appendChild(priceInput);

				var startInput = document.createElement("input");
				startInput.type = "hidden";
				startInput.name = "start";
				startInput.value = selectedEventData.start;
				form.appendChild(startInput);

				var endInput = document.createElement("input");
				endInput.type = "hidden";
				endInput.name = "end";
				endInput.value = selectedEventData.end;
				form.appendChild(endInput);

				var qtyInput2 = document.createElement("input");
				qtyInput2.type = "hidden";
				qtyInput2.name = "quantity";
				qtyInput2.value = selectedSeats.length;
				form.appendChild(qtyInput2);
			} else {
				return;
			}

			document.body.appendChild(form);
			form.submit();
		}
	</script>


</section>

